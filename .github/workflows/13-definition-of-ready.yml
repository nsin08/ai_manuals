name: Definition of Ready

on:
  issues:
    types: [labeled, edited]

permissions:
  issues: write
  contents: read

jobs:
  validate-dor:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'state:ready')
    steps:
      - name: Check DoR completion
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Check for required DoR elements
            const dorElements = [
              'Success Criteria',
              'Non-Goals',
              'Acceptance Criteria'
            ];
            
            const missingElements = dorElements.filter(element => 
              !body.includes(element)
            );
            
            if (missingElements.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `⚠️ **Definition of Ready Incomplete**\n\nMissing elements:\n${missingElements.map(e => `- ${e}`).join('\n')}\n\nPlease complete the DoR before marking as Ready.`
              });
              
              // Remove state:ready label
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'state:ready'
              });
              
              core.setFailed('DoR incomplete');
            }
            
            console.log('✅ DoR complete');
